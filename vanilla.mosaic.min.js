/**
 * Vanilla mosaic ;) (https://github.com/xylphid)
 * Version 0.2.0
 *
 * @author Anthony PERIQUET
 */
!function(t){var i=null,s={time:null,timeout:!1};t.mosaic=function(n,e){return this instanceof t.mosaic?(self=this,this.options=t.extend({},t.mosaic.defaults,e),this.elm=t(n),this.columns=[],this.ord=[],this.nbColumns,i=this,this.__init__(),t(window).on("resize",function(){i&&(s.time=new Date,s.timeout===!1&&(s.timeout=!0,setTimeout(t.mosaic.update,200)))}),void setTimeout(t.mosaic.update,1e3)):new t.mosaic(n,e)},t.mosaic.prototype={constructor:t.mosaic,__init__:function(){this.items=this.elm.children(),this._configure(),this._cleanContainer(),this._process()},_append:function(t,i){return t.css("display","block").css("opacity",i?0:t.css("opacity")).css("position","absolute").css("transition","left 500ms, opacity 500ms, top 500ms"),this.elm.append(t),t},_configure:function(){if(this.columns=[],this.ord=[],this.containerWidth=this.options.fitWidth?this.elm.parent().innerWidth():this.elm.innerWidth(),this.columnWidth=this.options.columnWidth,!this.columnWidth){var t=this._append(this.items[0]);t.css("width",""),this.columnWidth=t.outerWidth()||this.columnWidth}this.nbColumns=parseInt(this.containerWidth/this.columnWidth)},_cleanContainer:function(){for(var t=0;t<this.items.length;t++)this.items[t].remove()},_getItemWidth:function(t,i){var s=parseInt(t.css("margin-left"))+parseInt(t.css("margin-right"));return this.columnWidth*i-s+"px"},_getSpan:function(t){var i=1;return t.outerWidth()&&t.outerWidth()>this.columnWidth&&(i=Math.round(t.outerWidth()/this.columnWidth)),i},_process:function(t){t="undefined"==typeof t?!0:t,this.elm.css("width",this.columnWidth*this.nbColumns+"px");for(var i=0;i<this.items.length;i++){var s=this._append(this.items[i],t),n=this._getSpan(s);this._prepareItem(s,n),this.items[i].css("width",this._getItemWidth(s,n))}this.elm.css("height",this._getMaxOfSlice(0,this.nbColumns)+"px")},_prepareItem:function(t,i){this.columns.length<this.nbColumns&&(this.ord.push(0),this.columns[this.columns.length]=[this.columnWidth*this.columns.length,0]);var s=t.children("img")[0];s.nodes[0].complete?this._setPosition(t,s,i):s.on("load",function(){self._setPosition(t,s,i)})},_setPosition:function(t,i,s){var n=parseInt(t.css("margin-left")),e=(parseInt(t.css("margin-right")),parseInt(t.css("margin-top"))),o=parseInt(t.css("margin-bottom"));index=self._getOptimalPosition(s);var h=this._getMaxOfSlice(index,s)+e;t.css("left",this.columns[index][0]+n+"px").css("top",h+"px").css("opacity",1),this._updateColumns(index,i.nodes[0].offsetHeight+e+o,s)},_getOptimalPosition:function(t){for(var i=null,s=0;s<this.nbColumns-t+1;s++){var n=this._getMaxOfSlice(s,t);i=!i||i[1]>n?[s,n]:i}return i[0]},_updateColumns:function(t,i,s){if(s>1)var n=this._getMaxOfSlice(t,s);for(;s;)this.columns[t]||(this.ord[t]=0,this.columns[t]=[this.columnWidth*this.columns.length,0]),this.ord[t]="undefined"!=typeof n?n+i:this.ord[t]+i,this.columns[t][1]=this.ord[t],t++,s--},_getMaxOfSlice:function(t,i){for(var s=this.ord.slice(t,t+i);s.length<i;)s.push(0);return Math.max.apply(Math,s)},append:function(t){this.items.push(t);var t=this._append(t),i=this._getSpan(t);this._prepareItem(t,i),t.css("width",this._getItemWidth(t,i)),this.elm.css("height",this._getMaxOfSlice(0,this.nbColumns)+"px")},update:function(){this._configure(),this._cleanContainer(),this._process(!1),s.timeout=!1}},t.mosaic.defaults={columnWidth:null,fitWidth:!0},t.mosaic.dispatcher=function(t,s){return i&&"function"==typeof i[s]?(/Event/.test(t)&&t.preventDefault(),i[s](t),i):void 0},t.mosaic.update=function(i){return t.mosaic.dispatcher(i,"update")},t.mosaic.append=function(t){return i?i.append(t):void 0},t.prototype.mosaic=function(s){return this instanceof t&&(i=new t.mosaic(this,s),t.mosaic.open()),this}}(vanilla);